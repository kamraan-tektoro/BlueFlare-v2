#cloud-config
# Cloud-init configuration for Uptime Kuma on Azure VM
# This script installs Docker and runs Uptime Kuma with persistent storage

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw

runcmd:
  # Install Docker
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  
  # Enable and start Docker service
  - systemctl enable docker
  - systemctl start docker
  
  # Create data directory for Uptime Kuma
  - mkdir -p /opt/uptime-kuma
  - chmod 755 /opt/uptime-kuma
  
  # Remove existing container if exists (idempotent)
  - docker rm -f uptime-kuma 2>/dev/null || true
  
  # Run Uptime Kuma container
  - |
    docker run -d \
      --name uptime-kuma \
      --restart unless-stopped \
      -p ${kuma_port}:3001 \
      -v /opt/uptime-kuma:/app/data \
      ${kuma_container_image}
  
  # Configure UFW firewall (secondary protection, NSG is primary)
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow ${kuma_port}/tcp
  - ufw --force enable
  
  # Create a simple startup script for container recovery
  - |
    cat > /opt/uptime-kuma/start-kuma.sh << 'SCRIPT'
    #!/bin/bash
    # Ensure Uptime Kuma is running
    if ! docker ps | grep -q uptime-kuma; then
      docker rm -f uptime-kuma 2>/dev/null || true
      docker run -d \
        --name uptime-kuma \
        --restart unless-stopped \
        -p ${kuma_port}:3001 \
        -v /opt/uptime-kuma:/app/data \
        ${kuma_container_image}
    fi
    SCRIPT
  - chmod +x /opt/uptime-kuma/start-kuma.sh
  
  # Add cron job to ensure container is running after reboot
  - echo "@reboot root /opt/uptime-kuma/start-kuma.sh" >> /etc/crontab

final_message: "Uptime Kuma installation complete. Access at http://$(curl -s ifconfig.me):${kuma_port}"

